Chris's Wiki :: blog/linux/NftablesImplementingAPflog   

[Chris Siebenmann](/~cks/) :: [CSpace](/~cks/space/) » [blog](/~cks/space/blog/) » [linux](/~cks/space/blog/linux/) » NftablesImplementingAPflog

Welcome, guest.

## Implementing a basic equivalent of OpenBSD's pflog in Linux nftables

August 12, 2025

OpenBSD's and FreeBSD's PF system has a very convenient 'pflog' feature, where you put in a ['`log`'](https://man.openbsd.org/pf.conf.5#log) bit in a PF rule and this dumps a copy of any matching packets into a [pflog](https://man.openbsd.org/pflog.4) pseudo-interface, where you can both see them with 'tcpdump -i pflog0' and have them automatically logged to disk by [pflogd](https://man.openbsd.org/pflogd.8) in pcap format. Typically we use this to log blocked packets, which gives us both immediate and after the fact visibility of what's getting blocked (and [by what rule](/~cks/space/blog/unix/OpenBSDPflogTcpdump), [also](/~cks/space/blog/unix/OpenBSDPflogTcpdumpII)). It's possible to mostly duplicate this in Linux [nftables](https://wiki.nftables.org/), although [with more work and there's less documentation on it](https://mastodon.social/@cks/115013591299955832).

The first thing you need is nftables rules with one or two [log statements](https://netfilter.org/projects/nftables/manpage.html#lbDG) of the form 'log group <some number>'. If you want to be able to both log packets for later inspection and watch them live, you need two 'log group' statements with different numbers; otherwise you only need one. You can use different (group) numbers on different nftables rules if you want to be able to, say, look only at accepted but logged traffic or only dropped traffic. In the end this might wind up looking something like:

> tcp port ssh counter log group 30 log group 31 drop;

As the nft manual page will tell you, this uses the kernel 'nfnetlink\_log' to forward the 'logs' (packets) to a netlink socket, where exactly one process (at most) can subscribe to a particular group to receive those logs (ie, those packets). If we want to both log the packets and be able to tcpdump them, we need two groups so we can have [ulogd](https://netfilter.org/projects/ulogd/index.html) getting one and tcpdump getting the other.

To see packets from any particular log group, we use the special 'nflog:<N>' pseudo-interface that's hopefully supported by your Linux version of tcpdump. This is used as '`tcpdump -i nflog:30 ...`' and works more or less like you'd want it to. However, as far as I know there's no way to see meta-information about the nftables filtering, such as what rule was involved or what the decision was; you just get the packet.

To log the packets to disk for later use, the default program is ulogd, which in Ubuntu is called 'ulogd2'. Ulogd(2) isn't as automatic as OpenBSD's and FreeBSD's pf logging; instead you have to configure it in /etc/ulogd.conf, and on Ubuntu make sure you have the 'ulogd2-pcap' package installed (along with ulogd2 itself). Based merely on getting it to work, what you want in /etc/ulogd.conf is the following three bits:

> \# A 'stack' of source, handling, and destination
> stack=log31:NFLOG,base1:BASE,pcap31:PCAP
> 
> # The source: NFLOG group 31, for IPv4 traffic
> \[log31\]
> group=31
> # addressfamily=10 for IPv6
> 
> # the file path is correct for Ubuntu
> \[pcap31\]
> file="/var/log/ulog/ulogd.pcap"
> sync=0

(On Ubuntu 24.04, any .pcap files in /var/log/ulog will be automatically rotated by logrotate, although I think by default it's only weekly, so you might want to make it daily.)

The ulogd documentation suggests that you will need to capture IPv4 and IPv6 traffic separately, but I've only used this on IPv4 traffic so I don't know. This may imply that you need separate nftables rules to log (and drop) IPv6 traffic so that you can give it a separate group number for ulogd (I'm not sure if it needs a separate one for tcpdump or if tcpdump can sort it out).

Ulogd can also log to many different things than PCAP format, including JSON and databases. It's possible that there are ways to enrich the ulogd pcap logs, or maybe just the JSON logs, with additional useful information such as the network interface involved and other things. I find the ulogd documentation somewhat opaque on this (and also it's incomplete), and I haven't experimented.

(According to [this](https://jmorano.moretrix.com/2022/03/logging-in-iptables-with-nflog-and-ulogd2/), the JSON logs can be enriched or maybe default to that.)

Given the assorted limitations and other issues with ulogd, I'm tempted to not bother with it and only have our nftables setups support live tcpdump of dropped traffic with a single 'log group <N>'. This would save us from the assorted annoyances of ulogd2.

PS: One reason to log to pcap format files is that then you can use all of the tcpdump filters that you're already familiar with in order to narrow in on (blocked) traffic of interest, rather than having to put together a JSON search or something.

([One comment](/~cks/space/blog/linux/NftablesImplementingAPflog?showcomments#comments).)

Written on [12](/~cks/space/blog/2025/08/12/) [August](/~cks/space/blog/2025/08/) [2025](/~cks/space/blog/2025/).  

«

[The 'nft' command may not show complete information for iptables rules](/~cks/space/blog/linux/NftablesPartialIptablesRules)

[Another reason to use expendable email addresses for everything](/~cks/space/blog/spam/UseExpendableAddressesII)

»

These are my [WanderingThoughts](/~cks/space/blog/)  
([About the blog](/~cks/space/AboutBlog))

[Full index of entries](/~cks/space/blog/__Index)  
[Recent comments](/~cks/space/blog/__RecentComments)

This is part of [CSpace](/~cks/space/FrontPage), and is written by [ChrisSiebenmann](/~cks/space/People/ChrisSiebenmann).  
Mastodon: [@cks](https://mastodon.social/@cks)  
Twitter @thatcks

\* \* \*

Categories: [links](/~cks/space/blog/links/), [linux](/~cks/space/blog/linux/), [programming](/~cks/space/blog/programming/), [python](/~cks/space/blog/python/), [snark](/~cks/space/blog/snark/), [solaris](/~cks/space/blog/solaris/), [spam](/~cks/space/blog/spam/), [sysadmin](/~cks/space/blog/sysadmin/), [tech](/~cks/space/blog/tech/), [unix](/~cks/space/blog/unix/), [web](/~cks/space/blog/web/)  
Also: [(Sub)topics](/~cks/space/blog/__Topics)

This is a [DWiki](/~cks/space/dwiki/DWiki).  
[GettingAround](/~cks/space/help/GettingAround)  
([Help](/~cks/space/help/Help))

Search: 

* * *

Page tools: [View Source](/~cks/space/blog/linux/NftablesImplementingAPflog?source), [Add Comment](/~cks/space/blog/linux/NftablesImplementingAPflog?writecomment).

Search: 

Login:  Password:    

Atom Syndication: [Recent Comments](/~cks/space/blog/linux/NftablesImplementingAPflog?atomcomments).

* * *

Last modified: Tue Aug 12 22:38:29 2025  

This dinky wiki is brought to you by the Insane Hackers Guild, Python sub-branch.