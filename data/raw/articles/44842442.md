Title: How not to break a site ‚Äì sirre.al

URL Source: https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/

Published Time: Sat, 09 Aug 2025 08:05:22 GMT

Markdown Content:
`<script>` tags follow unintuitive parsing rules that can break a webpage in surprising ways. Fortunately, it‚Äôs relatively straightforward to escape JSON for script tags.

Just do this
------------

*   Replace `<` with `\x3C` or `\u003C` in JSON strings.
*   In PHP, use`json_encode($data, JSON_HEX_TAG | JSON_UNESCAPED_SLASHES)`for safe JSON in`<script>`tags.
*   In WordPress, use `wp_json_encode` with the same flags.

You don‚Äôt have to take my word for it, the [HTML standard recommends this type of escaping](https://html.spec.whatwg.org/multipage/scripting.html#restrictions-for-contents-of-script-elements):

> The easiest and safest ‚Ä¶ is to always escape an ASCII case-insensitive match for ‚Äú`<!--`‚Äù as ‚Äú`\x3C!--`‚Äú, ‚Äú`<script`‚Äù as ‚Äú`\x3Cscript`‚Äú, and ‚Äú`</script`‚Äù as ‚Äú`\x3C/script`‚Äú‚Ä¶

This post will dive deep into the exotic script tag parsing rules in order to understand how they work and why this is the appropriate way to escape JSON.

What‚Äôs so gnarly about a script tag?
------------------------------------

Script tags are used to embed other languages in HTML. The most common example is JavaScript:

This is great, JavaScript can be embedded directly. Imagine if script tags required HTML escaping:

In fact, script tags can contain any language (not necessarily JavaScript) or even arbitrary data. In order to support this behavior, script tags have special parsing rules. For the most part, the browser accepts _whatever_ is inside the script tag until it finds the script close tag `</script>`[1](https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/#7b3580c4-6ee3-49a2-9c93-2178535174da).

So, what happens when we embed this perfectly valid JavaScript that contains a script close tag?

Oops! We can see that `</script>` was part of a JavaScript string, but the browser is just parsing the HTML. This script element closes prematurely, resulting in the following tree:

```
‚îú‚îÄSCRIPT
‚îÇ ‚îî‚îÄ#text console.log('
‚îî‚îÄ#text ')
```

Ok, let‚Äôs use `json_encode()` and we should be all set:

Now we‚Äôve got this HTML:

`</script>` has become `<\/script>`. The JavaScript string value is preserved and the script element does not close prematurely. Perfect, right?

Not so fast, things are about to get messy
------------------------------------------

Let‚Äôs expand with a more complex example. Here‚Äôs some data used by an imaginary HTML library. We‚Äôll escape the JSON again with `json_encode`[2](https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/#57f5126d-21a4-41e0-a4fa-9589b6599e43):

Our HTML page includes the following, with a safely escaped script close tag:

Lovely. We‚Äôre good at this. Let‚Äôs just ship that üöÄ

* * *

üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•

* * *

Great. Production is now a blank page and we need to write a post-mortem. What happened? The HTML looks just fine. [Let‚Äôs inspect the document tree](https://software.hixie.ch/utilities/js/live-dom-viewer/?%3Cscript%3E%7B%0A%20%20%20%20%22closeComment%22%3A%20%22--%3E%22%2C%0A%20%20%20%20%22closeScript%22%3A%20%22%3C%5C%2Fscript%3E%22%2C%0A%20%20%20%20%22openComment%22%3A%20%22%3C!--%22%2C%0A%20%20%20%20%22openScript%22%3A%20%22%3Cscript%3E%22%0A%7D%3C%2Fscript%3E%0A%3Ch1%3ESuccess!%20%F0%9F%8E%89%3C%2Fh1%3E):

```
‚îî‚îÄSCRIPT
  ‚îî‚îÄ#text {‚êä
              "closeComment": "-->",‚êä
              "closeScript": "<\/script>",‚êä
              "openComment": "<!--",‚êä
              "openScript": "<script>"‚êä
          }</script>‚êä
          <h1>Success! üéâ</h1>
```

The script tag did not close as expected at `</script>`. The script close tag and all of the subsequent HTML are _part of the script tag contents_.

Wait, what???
-------------

We‚Äôve just discovered some of those unintuitive parsing rules. In short, the [HTML parser entered _script data double escaped state_](https://html.spec.whatwg.org/multipage/parsing.html#script-data-double-escaped-state) and got stuck. [Yes, this does break real pages.](https://core.trac.wordpress.org/ticket/62797)

If you‚Äôre not steeped in HTML arcana, fear not, this handy chart should clarify things üôÉ

[](https://i0.wp.com/sirre.al/wp-content/uploads/2025/08/html-script-data.png?ssl=1)
This is a real and mostly accurate diagram of how script tag tokenization works. I‚Äôve taken some liberties with things like end-of-file tokens and null bytes that aren‚Äôt relevant to the discussion.

You may be wondering, like I did, why HTML would work like this. [Well, the web wasn‚Äôt always the mature platform we know and love today:](https://stackoverflow.com/a/52157140/1432801)

> When JavaScript was first introduced, many browsers did not support it. So they would render the content of the script tag ‚Äì the JavaScript code itself. The normal way to get around that was to put the script into a comment ‚Äî things like

This kind of practice was commonplace on the web. As the web evolved, browsers continued to support the behavior so they wouldn‚Äôt break existing pages. Then, HTML5 came along and standardized the behavior so folks knew what to expect, even if it‚Äôs surprising. We can see other remnants of this practice in the [HTML scripting specification:](https://html.spec.whatwg.org/multipage/scripting.html#restrictions-for-contents-of-script-elements)

> for related historical reasons, the string ‚Äú<!‚Äì‚Äù in classic scripts is actually treated as a line comment start, just like ‚Äú//‚Äù.

Back to our _script data double escaped state_. We can simplify the diagram above to collapse some states and focus on the interesting transitions:

This diagram names some transitions `<script` and `</script`. This is true, but the tag name only matches when the name _script_ is followed by a byte that terminates a tag name ‚Äî Space, Tab, ‚Äú/‚Äù, ‚Äú>‚Äù, or a newline (`\n`, `\f`, `\r`). For example, `<script-o-rama` or `</scripty` do not transition.

To understand the problem with our example above, locate the three transitions for `</script`:

*   script data ‚Üí close
*   script data escaped ‚Üí close
*   ‚ÄºÔ∏è **script data double escaped ‚Üí script data escaped** ‚ÄºÔ∏è

`</script>` does not close a script element from the _script data double escaped state_.

[I encourage you to pause for a moment and play with this example to get a feel for how the script tag escaped states work.](https://software.hixie.ch/utilities/js/live-dom-viewer/?%3Cscript%3E%0A%2F%2F%20The%20following%20line%20will%20enter%20_script%20data%20double%20escaped%20state_%20%F0%9F%98%B1%0A%3C!--%3Cscript%0A%0A%2F%2F%20Remove%20the%20%22x%22%20here%20to%20exit%20_double%20escaped_%3A%20%3C%2Fscriptx%0A%2F%2F%20Complete%20comment%20closer%20here%20(add%20%22-%22)%20to%20exit%20_double%20escaped_%3A%20-%3E%0A%3C%2Fscript%3E%0A%3Ch1%3EIf%20this%20renders%2C%20you%20closed%20the%20script%20tag!%3C%2Fh1%3E)

Avoid the doubled escaped state
-------------------------------

The complexity of script tag parsing and escaping comes from the escaped states. **Avoid the _script data double escaped state_ and script tags become simple.** Everything until the tag closer `</script>` is inside the script element.

How can we avoid the double escaped state? Script tag parsing always starts in the _script data state_ and there‚Äôs a pattern in its transitions:

*   `</script`: _script data_ ‚Üí close
*   `<!--`: _script data_ ‚Üí _script data escaped_

Both require ‚Äú`<`‚Äù as their first character![3](https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/#fe8aa7b6-0506-40e9-b4b8-cfd3422d52ed) Everything will be handled predictably if `<` never appears inside of the script tag. [Remember what the HTML standard on scripting said?](https://html.spec.whatwg.org/multipage/scripting.html#restrictions-for-contents-of-script-elements) It recommends escaping `<` in specific places:

> [Escape] ‚Äú`<!--`‚Äù as ‚Äú`\x3C!--`‚Äú, ‚Äú`<script`‚Äù as ‚Äú`\x3Cscript`‚Äú, and ‚Äú`</script`‚Äù as ‚Äú`\x3C/script`‚Äù [in literals.]

PHP has the **`JSON_HEX_TAG`** flag that will escape all `<` as `\u003C` and `>``\u003E`. This will escape much more than is strictly necessary, but it‚Äôs sufficient and is provided by the language. Perfect!

How to escape JSON escaping in PHP
----------------------------------

For JSON that will be printed in a script tag, use the following flags:

*   `JSON_HEX_TAG`

_All < and > are converted to \u003C and \u003E._
*   `JSON_UNESCAPED_SLASHES`

_Don‚Äôt escape`/`._

If everything is UTF-8 (both the data and the charset of the page) you can add these flags for cleaner and shorter JSON:

*   `JSON_UNESCAPED_UNICODE`

_Encode multibyte Unicode characters literally (default is to escape as \uXXXX)._
*   `JSON_UNESCAPED_LINE_TERMINATORS`

_The line terminators are kept unescaped when`JSON\_UNESCAPED\_UNICODE`is supplied. It uses the same behaviour as it was before PHP 7.1 without this constant. Available as of PHP 7.1.0._

`JSON_UNESCAPED_LINE_TERMINATORS` is a fun one. Before ES2019, JavaScript strings did not accept two characters `U+2028 (LINE SEPARATOR)` and `U+2029 (PARAGRAPH SEPARATOR)` that JSON strings _do_ allow. Some valid JSON was invalid JavaScript. Since the [JavaScript is a superset of JSON proposal](https://github.com/tc39/proposal-json-superset) landed in ES2019, that‚Äôs no longer the case and those characters no longer require escaping. Phew! [Browser support today is very good.](https://caniuse.com/mdn-javascript_builtins_json_json_superset)

JSON escaping in action
-----------------------

Here‚Äôs the problematic example again, now with the recommended flags:

Let‚Äôs see the printed HTML and its resulting tree:

```
‚îú‚îÄSCRIPT
‚îÇ ‚îî‚îÄ#text {‚êä
‚îÇ             "closeComment": "--\u003E",‚êä
‚îÇ             "closeScript": "\u003C/script\u003E",‚êä
‚îÇ             "openComment": "\u003C!--",‚êä
‚îÇ             "openScript": "\u003Cscript\u003E"‚êä
‚îÇ         }
‚îú‚îÄ#text ‚êä 
‚îî‚îÄH1
  ‚îî‚îÄ#text Success! üéâ
```

‚ÄúSuccess! üéâ‚Äù is displayed and the tree structure is exactly what we expected.

What about JavaScript?
----------------------

The problems with JSON seem to be solved. But what about JavaScript source text? Or what if we decide to embed XML, Python, or Haskell in a script tag? All of those are permitted but bring different challenges.

Given what we learned here, see if you can find a general solution for escaping JavaScript safely. Remember that _script data double escaped state_ is dangerous and should be avoided. We also can‚Äôt allow the script tag to close prematurely with `</script>`. The path from our entry state to double-escaped looks like this:

*   _Script data state_: ‚Äú`<!--`‚Äù transition to
*   _Script data escaped state_: ‚Äú`<script>`‚Äù transition to
*   _Script data double escaped state_: ‚ÄºÔ∏è

* * *

The diagrams in this post were generated with [Mermaid](https://mermaid.js.org/). [Their source is available in this gist](https://gist.github.com/sirreal/806e5afdac1094164cff0037a6e175ab).

1.   It‚Äôs easiest to talk about `</script>` as the script close tag. Technically, it‚Äôs not strictly `</script>`, but a sequence of characters that looks like a script tag closer. For example `</SCRIPT/>` closes a script element but `</script-no>` does not. [‚Ü©Ô∏é](https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/#7b3580c4-6ee3-49a2-9c93-2178535174da-link)
2.   Several examples include `JSON_PRETTY_PRINT` in the output for legibility. This flag is omitted from the example code. [‚Ü©Ô∏é](https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/#57f5126d-21a4-41e0-a4fa-9589b6599e43-link)
3.   Script data transitions to [script data less-than sign state](https://html.spec.whatwg.org/multipage/parsing.html#script-data-less-than-sign-state) when the `<` character is encountered. That is the _only_ transition from the [script data state](https://html.spec.whatwg.org/multipage/parsing.html#script-data-state). [‚Ü©Ô∏é](https://sirre.al/2025/08/06/safe-json-in-script-tags-how-not-to-break-a-site/#fe8aa7b6-0506-40e9-b4b8-cfd3422d52ed-link)